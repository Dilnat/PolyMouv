#!/bin/bash
set -e

# Download grpcurl if not present (assuming linux x86_64)
if ! command -v ./grpcurl &> /dev/null; then
    echo "Downloading grpcurl..."
    curl -L -O https://github.com/fullstorydev/grpcurl/releases/download/v1.8.9/grpcurl_1.8.9_linux_x86_64.tar.gz
    tar -xvf grpcurl_1.8.9_linux_x86_64.tar.gz
    rm grpcurl_1.8.9_linux_x86_64.tar.gz
fi

echo "Listing Services..."
./grpcurl -plaintext localhost:50051 list

echo "Calling GetLatestNews (Limit 2)..."
./grpcurl -plaintext -d '{"limit": 2}' localhost:50051 mi8.MI8Service/GetLatestNews


# 2. Run Colporteur logic (simulate via Go run or compiled binary)
echo "Running Colporteur..."
cd ../colporteur
go run main.go
cd ../mi8

# 3. Verify
echo "Verifying news in MI8..."
./grpcurl -plaintext -d '{"limit": 10}' localhost:50051 mi8.MI8Service/GetLatestNews
